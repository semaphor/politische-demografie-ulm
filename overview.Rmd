---
title: "Datenanalyse zur Ulmer Gemeinderatswahl 2024"
subtitle: "ENTWURF | Altersstruktur von Bevölkerung, Wahllisten und Gemeinderat im Vergleich."
date: "28.5.2024"
author: "Jakob Pietron, Simon Lüke"
output:
  html_document:
    toc: true
    code_folding: hide
    number_sections: true
  pdf_document:
    toc: true
    number_sections: true
---

```{r message=FALSE}

# DIE SCHULTERN VIELER ANDERER, DANKE
# ===================================

library(ggridges)
library(ggplot2)
library(viridis)
library(hrbrthemes)
library(dplyr)
library(DT)
library(forcats)
library(ggpubr)
library(ragg)


# DATEN EINLESEN UND AUFBEREITEN
# ==============================

# Lokal wird/wurde zur Datenminimierung einmalig clean.R auf unseren Ausgangsdaten ausgeführt.


# KANDIDAT_INNEN/LISTEN:
#TODO Lfd.-Nr. wieder reinnehmen?
listen <- read.csv('daten/kandidat_innen-2024-09-06.csv')
colnames(listen) <- c('Beruf', 'Geburtsjahr', 'Stadtteil', 'Liste')
listen$Stadtteil <- as.factor(listen$Stadtteil)
listen$Liste <- as.factor(listen$Liste)
# Alter aus Geburtsjahr errechnen:
listen <- listen %>% mutate(Alter = 2024 - Geburtsjahr)
# Urspr. Berufsangabe in neue Spalte sichern:
listenHelper <- cbind(NA, listen$Beruf, listen)
names(listenHelper) <- c("Tätigkeit", "BerufAngabe", names(listen))
listen <- listenHelper
rm(listenHelper)
# Nach Median aufsteigend sortieren (schonmal hier, wird in den meisten Plots so gemacht):
listen <- listen %>% 
  mutate(Liste = fct_reorder(Liste, Alter, .fun='median'))
# n zählen:
listenLabels <- listen %>%
  group_by(Liste) %>%
  summarise(n = n()) %>%
  mutate(text = paste0(Liste, ' (n=', n, ')'))


# WAHLBERECHTIGTE:
#TODO offizielle Quelle finden/anfragen
wahlberechtigte=92000 # SWP-Artikel [6]


#AKTUELLER GEMEINDERAT:
aktRat <- read.csv('daten/aktueller_gemeinderat_2024-03.csv')
aktRat <- aktRat %>% mutate(Alter = 2024 - Geburtsjahr)


# ALTER ULM, Ulmer Statisitik 2023:
demografieUlm2023 <- read.csv('daten/demografie_ulm-2023-12-31-ulmer_statistik.csv')
names(demografieUlm2023)[11] <- "Wohnbevölkerung"
# Upsampling, so irgendwie (das geht sicher besser?)
demografieUlm2023Distr <- vector()
for (i in seq_along(demografieUlm2023$Wohnbevölkerung)) {
  demografieUlm2023Distr <- c(demografieUlm2023Distr, rep(demografieUlm2023$Alter.von[i], round(demografieUlm2023$Wohnbevölkerung[i])))
}
demografieUlm2023Distr <- as.data.frame(demografieUlm2023Distr)
demografieUlm2023Distr <- cbind(demografieUlm2023Distr,'Ulm')
names(demografieUlm2023Distr) <- c('Alter', 'Liste')
demografieUlm2023Distr <- cbind(NA, NA, NA, NA, NA, demografieUlm2023Distr)
names(demografieUlm2023Distr) <- c('Tätigkeit', 'BerufAngabe', 'Beruf', 'Geburtsjahr', 'Stadtteil', 'Alter', 'Liste')

# Extra data.frame: listen + demografieUlmDistr:
listenMitDemografieUlm2023 <- rbind(demografieUlm2023Distr, listen)

# Median ermitteln:
demografieUlm2023Median = median(demografieUlm2023Distr$Alter)


# ALTER ULM, DESTATIS:
demografieUlmGenderBi <- read.csv('daten/demografie_ulm-2022-12-31-statistisches_bundesamt.csv')
demografieUlmGenderBi$Geschlecht <- as.factor(demografieUlmGenderBi$Geschlecht)
# Nur zwei Geschlechter? Raus damit:
demografieUlmAnzAltersgruppen <- length(unique(demografieUlmGenderBi$Altersgruppe))
demografieUlmMtx <- matrix(nrow = demografieUlmAnzAltersgruppen, ncol = 2)
demografieUlmMtx[,1] <- sort(unique(demografieUlmGenderBi$Altersgruppe))
for (pos in seq(demografieUlmAnzAltersgruppen)) {
  demografieUlmMtx[pos,2] <- sum(demografieUlmGenderBi$Personen[demografieUlmGenderBi$Altersgruppe == demografieUlmMtx[pos,1]])
}
demografieUlm <- data.frame(demografieUlmMtx)
names(demografieUlm) <- names(demografieUlmGenderBi)[2:3]
# Altersgruppen in Schritten von zehn Jahren:
demografieUlm <- demografieUlm %>% mutate(AltersgruppeZehner = cut(Altersgruppe, breaks = seq(from = 0, to = 80, by = 10), right = FALSE))
levels(demografieUlm$AltersgruppeZehner)[levels(demografieUlm$AltersgruppeZehner) == "[70,80)"]  <- "[70,...)" 
demografieUlmZehner <- demografieUlm %>% select(any_of(c("AltersgruppeZehner", "Personen"))) %>%
  group_by(AltersgruppeZehner) %>% 
  summarise(across(everything(), sum))
rm(pos, demografieUlmMtx, demografieUlmAnzAltersgruppen)
# Upsampling, so irgendwie (das geht sicher besser?)
demografieUlmDistr <- vector()
for (i in seq_along(demografieUlm$Personen)) {
  mittleresAlter <- demografieUlm$Altersgruppe[i] + (demografieUlm$Altersgruppe[i+1] - demografieUlm$Altersgruppe[i]) / 2
  if (is.na(mittleresAlter)) mittleresAlter <- 75
  demografieUlmDistr <- c(demografieUlmDistr, rep(mittleresAlter ,round(demografieUlm$Personen[i])))
}
demografieUlmDistr <- as.data.frame(demografieUlmDistr)
demografieUlmDistr <- cbind(NA, NA, NA, NA, 'Ulm', demografieUlmDistr)
names(demografieUlmDistr) <- c('BerufAngabe', 'Beruf', 'Geburtsjahr', 'Stadtteil', 'Liste', 'Alter')

```

# Einleitung

Skizze:

* Wir halten für unsere Wahlentscheidungen Inhalte und Ziele der Listen als am wichtigsten. Dazu leider dieses Jahr kein Wahl-o-Mat, aber Websites der Listen, Diksussionsrunden, ggf. Presse.
* Für die Entscheidungen und Arbeit der Gemeinderät:innen aber auch wichtig sind die persönlichen Perspektiven und Erfahrungen. Jeder ist inidviudell, aber ein Blick auf die Statistik kann auch beitragen, um sich zur Stimmangabe ein Bild zu verschaffen.
* Deshalb hier ein Blick auf die Altersstrukturen und beruflichen Hintergründe/Tätigkeiten.
* Darunter dann ein ausführlichere/detaillierte Zusammenstellung der Daten und Informationen zur Vorgehensweise und den Quellen.
  * Zum selber blättern/tiefer reinschauen
  * Und ggf. selber weitermachen: offen z.B. noch Asuwertung mit Blick auf die Stadtteile; evtl. ist auch eine Auswertung nach Geschlechtern möglich.


# Zusammenfassung

Skizze:

1. Altersstruktur
   a. Kandidati:innen der Listen versus Bevölkerung
   a. aktueller Gemeinderat versus Bevölkerung
1. Beruflicher Hintergrund und Tätigkeiten
   a. Berufsgruppen
   a. aktuelle Tätigkeiten (da müssen wir wohl etwas mutmaßen, könnte man ja aber in einem Absatz erklären)



# Ausführlicher Bericht


## Altersstruktur

Skizze:

* Ulmer Bevölkerung zum Vergleich. Rat soll vertreten = wie bildet er ab/repräsentiert er?
* Unten ggf.(?) mehr, v.a. Median; Quantile; kein Durchschnittsalter.

 
### Kandidat:innen zur Ulmer Gemeinderatswahl

Insgesamt kandidieren für die Wahl am 9.6.2024 `r nrow(listen)` Kandidat_innen auf `r length(levels(listen$Liste))` Listen für den nächsten Ulmer Gemeinderat (Wahlperiode 2024-2029).


```{r}

# TABELLE ALTERSSTATISTIK LISTEN
# ==============================

listen %>%
  group_by(Liste) %>%
  #TODO (nice to have) Nicht nach Median, z.B. alphabetisch sortieren? mutate(Liste = fct_reorder(Liste, Liste, .fun='sort(unique())')) %>%
  summarise(
    "Kandidat_innen" = n(),
    "min. Alter" = min(Alter),
    "max. Alter" = max(Alter),
    "Alter, Median" = median(Alter),
    "Alter, Durchschnitt" = round(mean(Alter),1),
    "Alter, Standardabw." = round(sd(Alter))
    ) %>%
  datatable(style = 'bootstrap', options = list(pageLength = 16))
  #TODO Statt hart gecodetem 16 wäre eine Funktion schöner.
  # https://stackoverflow.com/questions/64684661/can-you-change-the-r-default-table-length-when-outputting-with-the-dt-package

```

Grafische Darstellung:

* Eintrag "Ulm": stellt zum Vergleich die gesamte Ulmer Bevölkerung dar [2].
* Histogram: TODO.
* Kurve: Annährung zur bessere Darstellung. Normierung auf Fläche unter der Kurve.
  * Da es sich um eine Annäherung und nicht um eine exakt Reprästentazion der Alterswerte handelt, verläuft die Kurz bspw. teilw. in Bereiche < 16 Jahre, also unter das Wahlalter.
* Blauer Strich: Median als Mittelwert.
* Grüner Strich: Wahlalter 16 Jahre.


```{r echo=FALSE}
#, message=FALSE, warning=FALSE, results='hide',fig.keep='all'} TODO Zeile könnte evtl. gelöscht werden?

# NOTIZEN ZUM CODE
# ================

# Knittr Options für Chunks:
# https://yihui.org/knitr/options/


# Fabenblindenfreundliche Farbpaletten:

#http://www.cookbook-r.com/Graphs/Colors_(ggplot2)/#a-colorblind-friendly-palette
# The palette with grey:
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

# The palette with black:
cbbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")

#https://www.datanovia.com/en/blog/ggplot-colors-best-tricks-you-will-love/#set-custom-color-palettes
anotherPalette <- c("#FFDB6D", "#C4961A", "#F4EDCA", "#D16103", "#C3D7A4", "#52854C", "#4E84C4", "#293352")

```


#### Vergleich Bevölkerung und alle Kanditat_innen

```{r fig.width=10, fig.align = 'center'}

# PLOT ALLE KANDIDAT_INNEN
# ========================

#TODO (nice to have) Quantile einzeichnen.

#TODO (nice to have) Vereinzelte Codeblöcke zusammenfassen.

plotAgeListenAlle <- listen %>%
  mutate(Liste = paste0('Alle Kandidat_innen\n(n = ', length(listen$Alter), ')')) %>%
  ggplot(aes(x = Alter, y = Liste)) +
  geom_density_ridges_gradient(
    scale = 45, 
    rel_min_height = 0.01, 
    bandwidth = 1.5,
    quantile_lines = TRUE,
    vline_color = c("#56B4E9"),
    vline_width = 1.5,
    quantile_fun = median,
    jittered_points = TRUE, #https://cran.r-project.org/web/packages/ggridges/vignettes/introduction.html
    position = position_points_jitter(width = 0.7, height = 0),
    point_shape = 20, #https://ggplot2.tidyverse.org/reference/aes_linetype_size_shape.html
    point_size = 2, point_alpha = .5, alpha = 0.7#,
    ) +
  geom_vline(xintercept = 16, colour="#E69F00", linetype = "longdash", linewidth = 0.8, show.legend = TRUE) +
  geom_vline(xintercept = demografieUlm2023Median, colour="#56B4E9", linetype = "longdash", linewidth = 0.8, show.legend = TRUE) +
  scale_fill_viridis() +
  #scale_y_discrete(limits=rev, labels=rev(listenLabels$text)) +
  scale_x_continuous(limits=c(0, 100), breaks=seq(0, 90, by=5)) +
  theme_ipsum() +
  theme(
    legend.position="none",
    panel.spacing = unit(0.1, "lines"),
    strip.text.x = element_text(size = 8),
    axis.title.y=element_blank(),
    axis.title.x=element_blank()
  )
#plotAgeListenAlle

```

```{r fig.width=10, fig.height=2.3, fig.align = 'center'}

# PLOT ULMER BEVÖLKERUNG
# ======================

#TODO Hohen leeren Bereich unterhalb x-Achse verkleinern.
#TODO Verbesserung: Quantile einzeichnen.

plotDemografieUlmDistr <- demografieUlm2023Distr %>%
  mutate(Liste = paste0('Ulm\n(n = ', length(demografieUlm2023Distr$Alter), ')')) %>%
  ggplot(aes(x = Alter, y = Liste)) +
  geom_density_ridges_gradient(
    scale = 45,
    rel_min_height = 0.01,
    quantile_lines = TRUE,
    vline_color = c("#56B4E9"),
    vline_width = 1.5,
    quantile_fun = median
    ) +
  geom_vline(xintercept = 16, colour="#E69F00", linetype = "longdash", linewidth = 0.8) +
  geom_vline(xintercept = demografieUlm2023Median, colour="#56B4E9", linetype = "longdash", linewidth = 0.8) +
  #scale_fill_viridis() +
  #scale_y_discrete(limits=rev, labels=rev(listenLabels$text)) +
  scale_x_continuous(limits=c(0, 100), breaks=seq(0, 90, by=5)) +
  #labs(title = 'Altersverteilung Ulmer Bevölkerung') +
  theme_ipsum() +
  theme(
    legend.position="none",
    panel.spacing = unit(0.1, "lines"),
    strip.text.x = element_text(size = 8),
    axis.title.y=element_blank(),
    axis.title.x=element_blank()
  )
#plotDemografieUlmDistr

```

```{r fig.width=10, fig.asp=0.5, message=FALSE, warning=FALSE, results='hide', fig.keep='all', fig.align = 'center'}

# PLOT ULMER BEVÖLKERUNG versus ALLE KANDIDAT_INNEN (Variante: einzelne Diagramme)

plotOben <- ggarrange(
  NA, plotDemografieUlmDistr,
  labels = c("(A)", NA),
  nrow = 1, ncol = 2,
  widths = c(0.062, 1) #TODO (nice to have) Verhältnis berechnen.
  )

plotUnten <- ggarrange(
  NA, plotAgeListenAlle,
  labels = c("(B)", NA),
  nrow = 1, ncol = 2,
  widths = c(0, 1)
  )

suppressWarnings(
ggarrange(
  plotOben,
  plotUnten,
  nrow = 2, ncol = 1,
  heights = c(1,1),
  vjust = 0
  )
)

# http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/81-ggplot2-easy-way-to-mix-multiple-graphs-on-the-same-page/
```


#### Vergleich der Listen

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.   

Duis autem vel eum iriure dolor in hendrerit in vulputate velit esse molestie consequat, vel illum dolore eu feugiat nulla facilisis at vero eros et accumsan et iusto odio dignissim qui blandit praesent luptatum zzril delenit augue duis dolore te feugait nulla facilisi. Lorem ipsum dolor sit amet,

```{r fig.width=10, fig.asp=1.5, warning=FALSE, fig.align = 'center'}

# PLOT LISTEN EINZELN

plotAgeListen <- listen %>%
  ggplot(aes(x = Alter, y = Liste)) +
  geom_density_ridges_gradient(
    scale = 2.1, 
    rel_min_height = 0.01, 
    bandwidth = 1.5,
    quantile_lines = TRUE,
    vline_color = c("#56B4E9"),
    vline_width = 1.5,
    quantile_fun = median,
    jittered_points = TRUE, #https://cran.r-project.org/web/packages/ggridges/vignettes/introduction.html
    position = position_points_jitter(width = 0.7, height = 0),
    point_shape = 20, #https://ggplot2.tidyverse.org/reference/aes_linetype_size_shape.html
    point_size = 2, point_alpha = .5, alpha = 0.7#,
    ) +
  #scale_colour_manual(values = c("#999999", "#E69F00", "#56B4E9", "#E69F00", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999", "#E69F00", "#56B4E9", "#E69F00", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")) +
  geom_vline(xintercept = 16, colour="#E69F00", linetype = "longdash", linewidth = 1, show.legend = TRUE) +
  geom_vline(xintercept = demografieUlm2023Median, colour="#56B4E9", linetype = "longdash", linewidth = 1, show.legend = TRUE) +
  scale_fill_viridis() +
  scale_y_discrete(limits=rev, labels=rev(listenLabels$text)) +
  scale_x_continuous(limits=c(0, 100), breaks=seq(0, 90, by=5)) +
  #labs(title = 'Altersverteilungen') +
  theme_ipsum() +
  theme(
    legend.position="none",
    panel.spacing = unit(0.1, "lines"),
    strip.text.x = element_text(size = 8),
    axis.title.y=element_blank(),
    axis.title.x=element_blank()
  )
#plotAgeListen

```

```{r fig.width=10, fig.asp=1.5, warning=FALSE, fig.align = 'center'}

# PLOT LISTEN EINZELN VS BEVOELKERUNG

plotAgeListenVSBevoelkerung <- listen %>%
  rbind(demografieUlm2023Distr %>%
          mutate(Liste = paste0('Ulm\n(n = ', length(demografieUlm2023Distr$Alter), ')'))) %>%
  ggplot(aes(x = Alter, y = Liste)) +
  geom_density_ridges_gradient(
    scale = 2.1, 
    rel_min_height = 0.01, 
    bandwidth = 1.5,
    quantile_lines = TRUE,
    vline_color = c("#56B4E9"),
    vline_width = 1.5,
    quantile_fun = median,
    jittered_points = TRUE, #https://cran.r-project.org/web/packages/ggridges/vignettes/introduction.html
    position = position_points_jitter(width = 0.7, height = 0),
    point_shape = 20, #https://ggplot2.tidyverse.org/reference/aes_linetype_size_shape.html
    point_size = 2, point_alpha = .5, alpha = 0.7#,
    ) +
  #scale_colour_manual(values = c("#999999", "#E69F00", "#56B4E9", "#E69F00", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999", "#E69F00", "#56B4E9", "#E69F00", "#F0E442", "#0072B2", "#D55E00", "#CC79A7", "#999999")) +
  geom_vline(xintercept = 16, colour="#E69F00", linetype = "longdash", linewidth = 1, show.legend = TRUE) +
  geom_vline(xintercept = demografieUlm2023Median, colour="#56B4E9", linetype = "longdash", linewidth = 1, show.legend = TRUE) +
  scale_fill_viridis() +
  scale_y_discrete(limits=rev, labels=rev(listenLabels$text)) +
  scale_x_continuous(limits=c(0, 100), breaks=seq(0, 90, by=5)) +
  #labs(title = 'Altersverteilungen') +
  theme_ipsum() +
  theme(
    legend.position="none",
    panel.spacing = unit(0.1, "lines"),
    strip.text.x = element_text(size = 8),
    axis.title.y=element_blank(),
    axis.title.x=element_blank()
  )
#plotAgeListenVSBevoelkerung

```

```{r fig.width=10, fig.asp=1.6, message=FALSE, warning=FALSE, results='hide', fig.keep='all', fig.align = 'center'}

plotOben <- ggarrange(
  NA, plotDemografieUlmDistr,
  labels = c("(A)", NA),
  widths = c(0.1, 1),
  nrow = 1, ncol = 2
  )

plotUnten <- ggarrange(
  NA, plotAgeListen,
  labels = c("(B)", NA),
  widths = c(0, 1),
  nrow = 1, ncol = 2
  )

suppressWarnings( #TODO Wird das noch benötigt?
ggarrange(
  plotOben, plotUnten,
  vjust = 0,
  heights = c(2,12),
  nrow = 2, ncol = 1
  )
)

# http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/81-ggplot2-easy-way-to-mix-multiple-graphs-on-the-same-page/
```

Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.   

Duis autem vel eum iriure dolor in hendrerit in vulputate velit esse molestie consequat, vel illum dolore eu feugiat nulla facilisis at vero eros et accumsan et iusto odio dignissim qui blandit praesent luptatum zzril delenit augue duis dolore te feugait nulla facilisi. Lorem ipsum dolor sit amet,


### Aktueller Gemeinderat

Der aktuelle Gemeinderat mit der Wahlperiode 2019-2024 setzt sich aus 41 Mitgliedern zusammen (40 + 1 OB).

```{r fig.width=10, fig.asp=1, fig.align = 'center'}
#options(repr.plot.width = 5, repr.plot.height = 2) 
plotAktRat <- aktRat %>%
  mutate(Fraktion = paste0('Gemeinderat\n2019-2024\n(n = ', length(aktRat$Alter), ')')) %>%
  ggplot(aes(x = Alter, y = Fraktion)) + #, fill = after_stat(x))) +
  geom_density_ridges_gradient(
    scale = 45,
    rel_min_height = 0.01,
    bandwidth = 1.5,
    quantile_lines = TRUE,
    vline_color = c("#56B4E9"),
    vline_width = 1.5,
    quantile_fun = median,
    jittered_points = TRUE, #https://cran.r-project.org/web/packages/ggridges/vignettes/introduction.html
    position = position_points_jitter(width = 0.7, height = 0),
    point_shape = 20, #https://ggplot2.tidyverse.org/reference/aes_linetype_size_shape.html
    point_size = 2, point_alpha = .5, alpha = 0.7
    ) +
  geom_vline(xintercept = 16, colour="#E69F00", linetype = "longdash", linewidth = 0.8) +
  geom_vline(xintercept = demografieUlm2023Median, colour="#56B4E9", linetype = "longdash", linewidth = 0.8) +
  #scale_fill_viridis() +
  #scale_y_discrete(limits=rev, labels=rev(listenLabels$text)) +
  scale_x_continuous(limits=c(0,100), breaks=seq(0, 90, by=5)) +
  #labs(title = 'Altersverteilung Ulmer Bevölkerung') +
  theme_ipsum() +
  theme(
    legend.position="none",
    panel.spacing = unit(0.1, "lines"),
    strip.text.x = element_text(size = 8),
    axis.title.y = element_blank(),
    axis.title.x = element_blank()
  )
#plotAktRat

plotAktRatMinus5 <- aktRat %>%
  mutate(Fraktion = paste0('Gemeinderat\n2019-2024\n-5 Jahre\n(n = ', length(aktRat$Alter), ')')) %>%
  mutate(Alter = Alter - 5) %>%
  ggplot(aes(x = Alter, y = Fraktion)) + #, fill = after_stat(x))) +
  geom_density_ridges_gradient(
    scale = 45,
    rel_min_height = 0.01,
    bandwidth = 1.5,
    quantile_lines = TRUE,
    vline_color = c("#56B4E9"),
    vline_width = 1.5,
    quantile_fun = median,
    jittered_points = TRUE, #https://cran.r-project.org/web/packages/ggridges/vignettes/introduction.html
    position = position_points_jitter(width = 0.7, height = 0),
    point_shape = 20, #https://ggplot2.tidyverse.org/reference/aes_linetype_size_shape.html
    point_size = 2, point_alpha = .5, alpha = 0.7
    ) +
  geom_vline(xintercept = 16, colour="#E69F00", linetype = "longdash", linewidth = 0.8) +
  geom_vline(xintercept = demografieUlm2023Median, colour="#56B4E9", linetype = "longdash", linewidth = 0.8) +
  #scale_fill_viridis() +
  #scale_y_discrete(limits=rev, labels=rev(listenLabels$text)) +
  scale_x_continuous(limits=c(0,100), breaks=seq(0, 90, by=5)) +
  #labs(title = 'Altersverteilung Ulmer Bevölkerung') +
  theme_ipsum() +
  theme(
    legend.position="none",
    panel.spacing = unit(0.1, "lines"),
    strip.text.x = element_text(size = 8),
    axis.title.y=element_blank(),
    #axis.title.x=element_blank()
  )
#plotAktRatMinus5
```

```{r fig.width=10, fig.asp=0.6, message=FALSE, warning=FALSE, results='hide', fig.keep='all', fig.align = 'center'}

plotOben <- ggarrange(
  NA, plotDemografieUlmDistr,
  labels = c("(A)", NA),
  nrow = 1, ncol = 2,
  widths = c(0, 1)
  )

plotUnten <- ggarrange(
  NA, plotAktRat,
  labels = c("(B)", NA),
  widths = c(0.007, 1),
  nrow = 1, ncol = 2
  )

plotGanzUnten <- ggarrange(
  NA, plotAktRatMinus5,
  labels = c("(C)", NA),
  widths = c(0.007, 1),
  nrow = 1, ncol = 2
  )

suppressWarnings(
ggarrange(
  plotOben,
  plotUnten,
  plotGanzUnten,
  nrow = 3, ncol = 1,
  vjust = 0,
  heights = c(2,2,2)
  )
)

# http://www.sthda.com/english/articles/24-ggpubr-publication-ready-plots/81-ggplot2-easy-way-to-mix-multiple-graphs-on-the-same-page/
```


### Ulmer Bevölkerung und Wahlberechtigte


<!--
#TODO Dezimalpunkte in der Zahlenausgabe
#TODO Altersgruppen/Quantile, evtl. als Tabelle.
-->


Wohnbevölkerung:

  * Gesamt: `r if (sum(demografieUlm2023$Wohnbevölkerung) == length(demografieUlm2023Distr$Alter)) {gesamt = sum(demografieUlm2023$Wohnbevölkerung); gesamt} else print("FEHLER: Ups, da ist was schief gegangen.")`
  * unter dem Wahlalter von 16 Jahren : `r { unterWahlalter = sum(demografieUlm2023$Wohnbevölkerung[demografieUlm2023$Alter.von <= 15]); unterWahlalter }` (`r round(( unterWahlalter / gesamt )*100, 1)` %)
  * über 16 Jahre: `r { imWahlalter = gesamt - unterWahlalter; imWahlalter }` (`r round(( imWahlalter/gesamt )*100, 1)` %), von diesen:
    * Anteil bis unter Median-Alter der Gesamtbevölkerung (16 bis unter `r demografieUlm2023Median` Jahre): `r sum(demografieUlm2023$Wohnbevölkerung[demografieUlm2023$Alter.von >= 16 & demografieUlm2023$Alter.von < demografieUlm2023Median])` (`r round(( sum(demografieUlm2023$Wohnbevölkerung[demografieUlm2023$Alter.von >= 16 & demografieUlm2023$Alter.von < demografieUlm2023Median]) / gesamt )*100, 1)` % der Gesamtbevölkerung bzw.  `r round(( sum(demografieUlm2023$Wohnbevölkerung[demografieUlm2023$Alter.von >= 16 & demografieUlm2023$Alter.von < demografieUlm2023Median]) / imWahlalter )*100, 1)` % der ab 16-jährigen).
    * Anteil ab Median-Alter Gesamtbevölkerung (ab `r demografieUlm2023Median` Jahre): `r sum(demografieUlm2023$Wohnbevölkerung[demografieUlm2023$Alter.von >= demografieUlm2023Median])` (`r round(( sum(demografieUlm2023$Wohnbevölkerung[demografieUlm2023$Alter.von >= demografieUlm2023Median]) / gesamt )*100, 1)` % der Gesamtbevölkerung bzw. `r round(( sum(demografieUlm2023$Wohnbevölkerung[demografieUlm2023$Alter.von >= demografieUlm2023Median]) / imWahlalter )*100, 1)` % der ab 16-jährigen).
    * Von 16 bis unter 18 Jahren: `r sum(demografieUlm2023$Wohnbevölkerung[demografieUlm2023$Alter.von >= 16 & demografieUlm2023$Alter.von < 18])` (`r round(( sum(demografieUlm2023$Wohnbevölkerung[demografieUlm2023$Alter.von >= 16 & demografieUlm2023$Alter.von < 18]) / imWahlalter )*100, 1)` %).


Wahlberechtigte:

* Gesamt: `r wahlberechtigte`, wodurch sich folgende Anteile ergeben:
  * `r round(( wahlberechtigte/gesamt )*100, 1)` % der gesamten Wohnbevölkerung sind wahlberechtigt.
  * Von der Wohnbevölkerung ab 16 Jahren/im Wahlalter sind `r round(( wahlberechtigte / imWahlalter )*100, 1)` % wahlberechtigt.


Vergleich mit Baden-Württemberg, nach Schätzungen des Statistischen Landesamtes [5] (Werte also ungefähr):

* Gesamtbevölkerung: 11,3 Millionen [6]
* Wahlberechtigte: 8,6 Millionen (`r round(( 8.6 / 11.3 )*100, 1)` %; 7,8 Mio. Deutsche, 0,8 Mio. Unionsbürger_innen).
* Wahlberechtigte unter 18 Jahren: 190.000 (2,3 % der Wahlberechtigten).
* "Insgesamt sind ca. 10,9 % der wahlberechtigten Bevölkerung Baden-Württembergs zwischen 16 und 24 Jahren. In den Parlamenten ist diese Altersgruppe allerdings kaum vertreten, so sind derzeit im Landtag nur 0,6 % und im Bundestag nur 0,8 % der Abgeordneten unter 25 Jahren."


Zum Datensatz:

* Quelle Wohnbevölkerung: Ulmer Statistik 2023 [2], mit Stichtag 31.12.2023.
  * Auflösung der Daten: Altersgruppen von je 1 Jahr, ab 0 Jahren.
  * Letzter Datenpunkt enthält alle Personen 90 Jahre und älter, deshalb sieht man hier ein Ausreißer nach oben.
* Quelle Anzahl Wahlberechtigten: SWP [6].


```{r fig.width=7, fig.asp=0.33, fig.align = 'center'}

plotAgeUlm2023Distr <- ggplot(demografieUlm2023Distr, aes(Alter)) + 
  geom_histogram(binwidth = 1) +
  scale_x_continuous(breaks=seq(0, 90, by=10))

plotAgeUlm2023Distr

# Zum Vergleich hier optional eine Darstellung der ursprünglichen Daten aus [2]:
#plotAgeUlm2023 <- ggplot(demografieUlm2023, aes(Alter.von, Wohnbevölkerung)) + 
#  geom_col(width = 0.5)
#
#plotAgeUlm2023


```

Alternativ stellt das Statstische Bundesamt (DESTATIS) in der GENESIS-Datenbank folgende Altersdaten mit akttuell letztem Stand vom 31.12.2022 [3] zur Verfügung. Diese Daten sind also etwas älter und vor allem weniger fein aufgelöst. Alle Auswertungen in diesem Bericht basieren auf den Daten der Ulmer Statistik 2023, für Interessierte dennoch eine kurze Vorstellung:

Wohnbevölkerung DESTATIS:

* Gesamtzahl: `r sum(demografieUlmZehner$Personen)`

```{r fig.width=7, fig.asp=0.4, fig.align = 'center'}
plotAgeUlm2022DES <- ggplot(demografieUlmZehner, aes(AltersgruppeZehner, Personen)) + 
  geom_col(width = 0.8)

plotAgeUlm2022DES


```


## Beruflicher Hintergrund

Skizze:

* Angabe im Feld "Beruf oder Stand" aus der Bekanntmachung der Wahlvorschläge [1].
* Die vollständige Liste, die alle angegebenen Berufe enthält, finden Sie der [Datei kandidat_innen-2024-09-06.csv auf GitHub](https://github.com/semaphor/politische-demografie-ulm/blob/main/daten/kandidat_innen-2024-09-06.csv).
* Hier kommt wesentlich mehr Interpretation rein, z.B. die Zusammenfassung der Berufsangaben "Einzelunternehmer", "selbst. Unternehmer", "selbst. Unternehmerin" und "	Unternehmer IT-Services" zu "Unternehmer_in".

```{r}

# BERUFSANGABEN REDAKTIONELL BEREINIGEN:
#  * gegenderte Bezeichnungen
#  * rausschmeißen "i.R." "selbst." 

listen <- listen %>%
  mutate(Beruf = replace(Beruf, Beruf == "Student" | Beruf == 'Studentin', "Student_in")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Schüler" | Beruf == 'Schülerin', "Schüler_in")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Auszubildender" | Beruf == 'Auszubildende', "Auszubildende_r")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Arzt" | Beruf == 'Ärztin', "Ärzt_in")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Architekt" | Beruf == 'Architektin' | Beruf == "Freie Architektin", "Architekt_in")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Fraktionsgeschäftsführer" | Beruf == 'Fraktionsgeschäftsführerin', "Fraktionsgeschäftsführer_in")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Lehrer" | Beruf == 'Lehrerin' | Beruf == "Lehrer i.R." | Beruf == "Gymnasiallehrer" | Beruf == "Gymnasiallehrerin" | Beruf == "Kunstlehrerin", "Lehrer_in")) %>%
    mutate(Beruf = replace(Beruf,Beruf == "techn. Oberlehrer i.R." | Beruf == "techn. Oberlehrerin", "Berufsschullehrer_in")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Dipl. Betriebswirt (BA)" | Beruf == 'Dipl.- Betriebswirt (BA)' | Beruf == "	Dipl.-Betriebswirt (BA)", "Dipl. Betriebswirt_in (BA)")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "selbst. Dipl.-Informatiker" | Beruf == 'Dipl.-Informatikerin', "Dipl.-Informatiker_in")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "selbständig", "selbstständig")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Unternehmer" | Beruf == "Einzelunternehmer" | Beruf == "selbst. Unternehmer" | Beruf == "selbst. Unternehmerin" | Beruf == "Unternehmer IT-Services", "Unternehmer_in")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Geschäftsführer" | Beruf == "Geschäftsführerin", "Geschäftsführer_in")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Bankkaufmann" | Beruf == "Bankkauffrau", "Bankkaufleute")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Rechtsanwalt" | Beruf == "Rechtsanwältin" | Beruf == "Rechtsanwältin i.R.", "Rechtsanwält_in")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Rechtsanwaltsfach- angestellte", "Rechtsanwaltsfachangestellte")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "kaufm. Angestellter", "kaufm. Angestellte_r")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Kaufmann" | Beruf == "IT-Systemkaufmann" | Beruf == "Speditionskaufmann" | Beruf == "selbst. Kaufmann", "Kaufleute")) %>%
  #mutate(Beruf = replace(Beruf, Beruf == "" | Beruf == "", "")) %>%
  #mutate(Beruf = replace(Beruf, Beruf == "" | Beruf == "", "")) %>%
  #mutate(Beruf = replace(Beruf, Beruf == "" | Beruf == "", "")) %>%
  mutate(Beruf = replace(Beruf, Beruf == "Psychologe" | Beruf == 'Psychologin' | Beruf == "Sportpsychologe" | Beruf == "Psychologin (B.sc.)", "Psycholog_in"))
#Psychologische Beraterin i.R.? Psychologische Psychotherapeutin?


# Redaktionelle Zusammenfassung:
berufe <- listen %>%
            group_by(Beruf) %>%
            summarise(n = n()) %>%
            arrange(desc(n))

berufe %>%
  datatable(style = 'bootstrap', filter = 'top')

```


<!-- TODO Evtl. noch ein Abschnitt zu "Future Work" -->


# Vorgehensweise, Quellen und Autor_innen


Datenverarbeitung und Visualisierung mit der Statistiksoftware R. Automatisierte Erstellung des reproduzier- und nachvollziehbaren Berichts (diese Website) mit R Markdown. Veröffentlichung im Web mit GitHub (Actions). Tausend  Dank an alle Autor_innen der unzähligen genutzten freien Softwarepakte!


Daten und nachvollziehbare Datenverarbeitung auf GitHub: <https://github.com/semaphor/politische-demografie-ulm>

<!-- TODO (nice to have) automatische und verlinkte Referenzen zu den Quellen. -->

Quellen:

* [1] Öffentliche Bekanntmachung der Wahlvorschläge zur Wahl des Gemeinderats und der Ortschaftsräte am 09. Juni 2024, Stadt Ulm, 04.04.2024, [PDF](https://www.ulm.de/-/media/ulm/zdv/downloads/oeffentliche-bekanntmachungen/2024/april-2024/20240404zugelassene-wahlvorschlge-zur-wahl-des-gemeinderats-und-der-ortschaftsrte-am-09-juni-2024sig.pdf)
* [2] Die "Ulmer Statistik 2023" würde noch feiner aufgelöste und aktuellere Daten zur Alterstruktur enthalten [PDF](https://www.ulm.de/-/media/ulm/bd/bd-iv/statistik-und-wahlen/statistik/downloads/2023-ulmer-statistik-red/2023-ulmer-statistik-red1.pdf)
* [3] Tabelle 12411-0018 "Bevölkerung: Kreise, Stichtag, Geschlecht, Altersgruppen" für "Ulm, kreisfreie Stadt" (Code 08421), per 31.12.2022, Statistisches Bundesamt, [Website](https://www-genesis.destatis.de/genesis//online?operation=table&code=12411-0018&bypass=true&levelindex=0&levelid=1716154099952#abreadcrumb)
* [4] Zusammensetzung Ulmer Gemeinderat Wahlperiode 2019-2024:
  * Webseiten der Stadt Ulm, [Website](https://www.ulm.de/rathaus/stadtpolitik/gemeinderat)
  * Alter: Internetrecherche, diverse Quellen (auf Nachfrage bei den Autor\*innen)
* [5] Baden-Württemberg vor den Kommunalwahlen 2024, Monja Rinderle, Dirk Eisenreich, 
Statistisches Monatsheft Februar 2024, Statistisches Landesam Baden-Württemberg, [PDF](https://www.statistik-bw.de/Service/Veroeff/Monatshefte/PDF/Beitrag24_02_01.pdf)/ [Website](https://www.statistik-bw.de/Service/Veroeff/Monatshefte/20240201)
* [6] Es geht los! Die Unterlagen werden verschickt, 10.5.2024, Chirin Kolb, SWP, [Website](https://www.swp.de/lokales/ulm/kommunalwahl-in-ulm-es-geht-los-mit-der-wahl-73755939.html?refreshSession=1)
* [7] Bevölkerung nach Nationalität – vierteljährlich, Statistisches Landesam Baden-Württemberg, [Website](https://www.statistik-bw.de/BevoelkGebiet/Bevoelkerung/01035055.tab?R=LA)


Von: Jakob Pietron, Simon Lüke


Lizenz: TODO


Kontakt: TODO